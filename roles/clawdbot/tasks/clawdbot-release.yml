---
- name: Install Clawdbot globally as clawdbot user (using pnpm)
  ansible.builtin.shell:
    cmd: pnpm install -g clawdbot@latest
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    PNPM_HOME: "{{ clawdbot_home }}/.local/share/pnpm"
    PATH: "{{ clawdbot_home }}/.local/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ clawdbot_home }}"
  register: clawdbot_install
  changed_when: "'Already up to date' not in clawdbot_install.stdout"

- name: Verify clawdbot installation
  ansible.builtin.shell:
    cmd: "{{ clawdbot_home }}/.local/bin/clawdbot --version"
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  register: clawdbot_version
  changed_when: false

- name: Display installed Clawdbot version (release)
  ansible.builtin.debug:
    msg: "Clawdbot installed from npm: {{ clawdbot_version.stdout }}"
