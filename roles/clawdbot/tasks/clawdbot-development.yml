---
# Development mode installation - Clone repo, build from source, link globally

- name: Create code directory
  ansible.builtin.file:
    path: "{{ clawdbot_code_dir }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0755'

- name: Check if clawdbot repository already exists
  ansible.builtin.stat:
    path: "{{ clawdbot_repo_dir }}/.git"
  register: clawdbot_repo_exists

- name: Clone clawdbot repository
  ansible.builtin.git:
    repo: "{{ clawdbot_repo_url }}"
    dest: "{{ clawdbot_repo_dir }}"
    version: "{{ clawdbot_repo_branch }}"
    update: true
  become: true
  become_user: "{{ clawdbot_user }}"
  when: not clawdbot_repo_exists.stat.exists

- name: Pull latest changes if repo exists
  ansible.builtin.git:
    repo: "{{ clawdbot_repo_url }}"
    dest: "{{ clawdbot_repo_dir }}"
    version: "{{ clawdbot_repo_branch }}"
    update: true
  become: true
  become_user: "{{ clawdbot_user }}"
  when: clawdbot_repo_exists.stat.exists
  register: git_pull_result

- name: Display git pull status
  ansible.builtin.debug:
    msg: "Git repository updated: {{ git_pull_result.changed | default(false) }}"
  when: clawdbot_repo_exists.stat.exists

- name: Install dependencies with pnpm
  ansible.builtin.shell:
    cmd: pnpm install
    chdir: "{{ clawdbot_repo_dir }}"
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    PNPM_HOME: "{{ clawdbot_home }}/.local/share/pnpm"
    PATH: "{{ clawdbot_home }}/.local/bin:/home/linuxbrew/.linuxbrew/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ clawdbot_home }}"
  register: pnpm_install_result
  changed_when: "'Already up to date' not in pnpm_install_result.stdout"

- name: Build clawdbot from source
  ansible.builtin.shell:
    cmd: pnpm build
    chdir: "{{ clawdbot_repo_dir }}"
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    PNPM_HOME: "{{ clawdbot_home }}/.local/share/pnpm"
    PATH: "{{ clawdbot_home }}/.local/bin:/home/linuxbrew/.linuxbrew/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ clawdbot_home }}"
  register: pnpm_build_result
  changed_when: true  # Build always changes dist/ directory

- name: Display build output
  ansible.builtin.debug:
    msg: "Build completed successfully"
  when: pnpm_build_result.rc == 0

- name: Check if dist directory exists
  ansible.builtin.stat:
    path: "{{ clawdbot_repo_dir }}/dist"
  register: dist_dir

- name: Fail if build didn't create dist directory
  ansible.builtin.fail:
    msg: "Build failed - dist directory not found"
  when: not dist_dir.stat.exists

- name: Remove existing global clawdbot symlink (if any)
  ansible.builtin.file:
    path: "{{ clawdbot_home }}/.local/bin/clawdbot"
    state: absent

- name: Create symlink to clawdbot binary
  ansible.builtin.file:
    src: "{{ clawdbot_repo_dir }}/bin/clawdbot.js"
    dest: "{{ clawdbot_home }}/.local/bin/clawdbot"
    state: link
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    force: true

- name: Make clawdbot binary executable
  ansible.builtin.file:
    path: "{{ clawdbot_repo_dir }}/bin/clawdbot.js"
    mode: '0755'
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"

- name: Verify clawdbot installation from development build
  ansible.builtin.shell:
    cmd: "{{ clawdbot_home }}/.local/bin/clawdbot --version"
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    PATH: "{{ clawdbot_home }}/.local/bin:/usr/local/bin:/usr/bin:/bin"
  register: clawdbot_dev_version
  changed_when: false

- name: Display installed Clawdbot version (development build)
  ansible.builtin.debug:
    msg: |
      Clawdbot installed from source: {{ clawdbot_dev_version.stdout }}
      Repository: {{ clawdbot_repo_dir }}
      Binary: {{ clawdbot_home }}/.local/bin/clawdbot -> {{ clawdbot_repo_dir }}/bin/clawdbot.js

- name: Add development mode info to .bashrc
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Clawdbot development"
    block: |
      # Clawdbot development mode
      export CLAWDBOT_DEV_DIR="{{ clawdbot_repo_dir }}"

      # Aliases for development
      alias clawdbot-rebuild='cd {{ clawdbot_repo_dir }} && pnpm build'
      alias clawdbot-dev='cd {{ clawdbot_repo_dir }}'
      alias clawdbot-pull='cd {{ clawdbot_repo_dir }} && git pull && pnpm install && pnpm build'
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
